<div class="toast align-items-center text-white bg-black border-0"
     [class.show]="showMessage"
     role="alert"
     aria-live="assertive"
     aria-atomic="true">
  <div class="d-flex">
    <div class="toast-body">
      {{ message }}
    </div>
    <button type="button"
            class="btn-close btn-close-white me-2 m-auto"
            (click)="showMessage = false">
    </button>
  </div>
</div>

<app-page-header
  title="Users"
  description="Admin view of all users"
  [showDateFilter]="true"
  [searchMode]="true"
  [searchPlaceholder]="'Search people'"
  (filter)="onSearch($event)"
  (clearFilter)="onClearFilter()"
></app-page-header>

<section class="users-table mt-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="d-flex align-items-center">
      <label class="me-2">Per page:</label>
      <select class="form-select" style="width:100px" [ngModel]="pageSize" (ngModelChange)="onPageSizeChange($event)">
        <option [ngValue]="5">5</option>
        <option [ngValue]="10">10</option>
        <option [ngValue]="25">25</option>
        <option [ngValue]="50">50</option>
      </select>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr>
          <th scope="col">Avatar</th>
          <th scope="col" class="sortable" (click)="setSort('role')">Role <span class="sort-icon">{{ sortBy === 'role' ? (sortDir === 'asc' ? '↑' : '↓') : '⇅' }}</span></th>
          <th scope="col" class="sortable" (click)="setSort('email')">Email <span class="sort-icon">{{ sortBy === 'email' ? (sortDir === 'asc' ? '↑' : '↓') : '⇅' }}</span></th>
          <th scope="col" class="sortable" (click)="setSort('firstName')">Name <span class="sort-icon">{{ sortBy === 'firstName' ? (sortDir === 'asc' ? '↑' : '↓') : '⇅' }}</span></th>
          <th scope="col" class="sortable" (click)="setSort('lastName')">Surname <span class="sort-icon">{{ sortBy === 'lastName' ? (sortDir === 'asc' ? '↑' : '↓') : '⇅' }}</span></th>
          <th scope="col">Phone Number</th>
          <th scope="col" class="sortable" (click)="setSort('blocked')">Blocked <span class="sort-icon">{{ sortBy === 'blocked' ? (sortDir === 'asc' ? '↑' : '↓') : '⇅' }}</span></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of pagedUsers">
          <td style="width:60px">
            <img *ngIf="u.imageUrl; else noImg" [src]="u.imageUrl" alt="avatar" class="avatar-img" loading="lazy" (error)="onImgError(u)" />
            <ng-template #noImg>
              <div class="bg-secondary rounded-circle avatar-placeholder">
                <span class="avatar-initials">{{ (u.firstName||'').charAt(0) }}{{ (u.lastName||'').charAt(0) }}</span>
              </div>
            </ng-template>
          </td>
          <td>{{ u.role }}</td>
          <td>{{ u.email }}</td>
          <td>{{ u.firstName }}</td>
          <td>{{ u.lastName }}</td>
          <td>{{ u.phoneNumber || '-' }}</td>
          <td>
            <button
              class="btn btn-sm"
              [ngClass]="u.blocked ? 'btn-danger text-white' : 'btn-light text-black'"
              (click)="u.blocked ? openUnblockModal(u) : openBlockModal(u)"
              [attr.aria-pressed]="u.blocked"
              [title]="u.blocked ? 'Unblock user' : 'Block user'">
              {{ u.blocked ? 'Unblock' : 'Block' }}
            </button>
          </td>
        </tr>
        <tr *ngIf="totalUsers === 0">
          <td colspan="7" class="text-center">No users found.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <app-block-user-modal *ngIf="showBlockModal" [user]="selectedUser" (confirmed)="confirmBlock()" (cancelled)="showBlockModal = false"></app-block-user-modal>
  <app-unblock-user-modal *ngIf="showUnblockModal" [user]="selectedUser" (confirmed)="confirmUnblock()" (cancelled)="showUnblockModal = false"></app-unblock-user-modal>

  <div *ngIf="totalPages > 1" class="d-flex justify-content-center align-items-center gap-3 mb-3">
    <app-button text="←" variant="primary" height="30px" width="40px" [disabled]="currentPage === 1" (clicked)="changePage(currentPage - 1)"></app-button>
  <span class="text-muted"> page {{ currentPage }} of {{ totalPages }} ({{ totalUsers }} total users)</span>
    <app-button text="→" variant="primary" height="30px" width="40px" [disabled]="currentPage === totalPages" (clicked)="changePage(currentPage + 1)"></app-button>
  </div>
</section>
