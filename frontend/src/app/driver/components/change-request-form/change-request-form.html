<div class="cr-container">
  <header class="cr-header">
    <div>
      <h1>Admin â€” Change Request Review</h1>
    </div>
    <div class="cr-actions">
      <button class="btn btn-outline-secondary" (click)="onBack()">Back</button>
      <button class="btn btn-success" [disabled]="actionTaken" (click)="approveRequest()">Approve</button>
      <button class="btn btn-danger" [disabled]="actionTaken" (click)="rejectRequest()">Reject</button>
    </div>
  </header>

  <section class="cr-grid">
    <aside class="cr-card cr-profile">
      <div class="avatar-large">
        <img *ngIf="changedDriver?.avatarUrl; else initialsLeft" [src]="changedDriver.avatarUrl" alt="profile avatar">
        <ng-template #initialsLeft>{{ changedDriver.firstName?.charAt(0) }}{{ changedDriver.lastName?.charAt(0) }}</ng-template>
      </div>
      <h2 class="name">{{ changedDriver.firstName }} {{ changedDriver.lastName }}</h2>
      <div class="meta">
        <span class="chip">{{ changedDriver.role | uppercase }}</span>
        <span class="chip">Active: {{ changedDriver.activeHours }}h</span>
      </div>
      <ul class="contact-list">
        <li><strong>Phone:</strong> {{ changedDriver.phone }}</li>
        <li><strong>Email:</strong> {{ changedDriver.email }}</li>
        <li><strong>Address:</strong> {{ changedDriver.address }}</li>
      </ul>
    </aside>

    <main class="cr-card cr-details">
      <h3>Current vs Proposed</h3>

      <div class="diff-grid">
        <div class="diff-row header">
          <div class="label">Field</div>
          <div class="current">Current</div>
          <div class="proposed">Proposed</div>
        </div>

        <div class="diff-row">
          <div class="label">Avatar</div>
          <div class="current">
            <div class="avatar-thumb" [class.changed]="isAvatarChanged()">
              <img *ngIf="originalDriver?.avatarUrl; else noCurSmall" [src]="originalDriver.avatarUrl" alt="current avatar">
              <ng-template #noCurSmall><div class="avatar-initial">{{ originalDriver?.firstName?.charAt(0) || '?' }}</div></ng-template>
            </div>
          </div>
          <div class="proposed">
            <div class="avatar-thumb" [class.changed]="isAvatarChanged()">
              <img *ngIf="changedDriver?.avatarUrl; else noPropSmall" [src]="changedDriver.avatarUrl" alt="proposed avatar">
              <ng-template #noPropSmall><div class="avatar-initial">{{ changedDriver?.firstName?.charAt(0) || '?' }}</div></ng-template>
            </div>
          </div>
        </div>

        <div class="diff-row">
          <div class="label">Name</div>
          <div class="current">{{ originalDriver.firstName }} {{ originalDriver.lastName }}</div>
          <div class="proposed" [class.changed]="isFieldChanged('firstName') || isFieldChanged('lastName')">{{ changedDriver.firstName }} {{ changedDriver.lastName }}</div>
        </div>

        <div class="diff-row">
          <div class="label">Phone</div>
          <div class="current">{{ originalDriver.phone }}</div>
          <div class="proposed" [class.changed]="isFieldChanged('phone')">{{ changedDriver.phone }}</div>
        </div>

        <div class="diff-row">
          <div class="label">Email</div>
          <div class="current">{{ originalDriver.email }}</div>
          <div class="proposed" [class.changed]="isFieldChanged('email')">{{ changedDriver.email }}</div>
        </div>

        <div class="diff-row">
          <div class="label">Address</div>
          <div class="current">{{ originalDriver.address }}</div>
          <div class="proposed" [class.changed]="isFieldChanged('address')">{{ changedDriver.address }}</div>
        </div>

        <div class="diff-row">
          <div class="label">Vehicle Model</div>
          <div class="current">{{ originalDriver.vehicle?.model }}</div>
          <div class="proposed" [class.changed]="isFieldChanged('vehicle.model')">{{ changedDriver.vehicle?.model }}</div>
        </div>

        <div class="diff-row">
          <div class="label">License Plate</div>
          <div class="current">{{ originalDriver.vehicle?.licensePlate }}</div>
          <div class="proposed" [class.changed]="isFieldChanged('vehicle.licensePlate')">{{ changedDriver.vehicle?.licensePlate }}</div>
        </div>

        <div class="diff-row">
          <div class="label">Seats</div>
          <div class="current">{{ originalDriver.vehicle?.seats }}</div>
          <div class="proposed" [class.changed]="isFieldChanged('vehicle.seats')">{{ changedDriver.vehicle?.seats }}</div>
        </div>

        <div class="diff-row">
          <div class="label">Vehicle Type</div>
          <div class="current">{{ originalDriver?.missing ? 'No current data' : (originalDriver.vehicle?.type || '-') }}</div>
          <div class="proposed" [class.changed]="isFieldChanged('vehicle.type')">{{ changedDriver.vehicle?.type || '-' }}</div>
        </div>

        <div class="diff-row">
          <div class="label">Pet friendly</div>
          <div class="current">{{ originalDriver.vehicle?.petFriendly ? 'Yes' : 'No' }}</div>
          <div class="proposed" [class.changed]="isFieldChanged('vehicle.petFriendly')">{{ changedDriver.vehicle?.petFriendly ? 'Yes' : 'No' }}</div>
        </div>

        <div class="diff-row">
          <div class="label">Baby friendly</div>
          <div class="current">{{ originalDriver.vehicle?.babyFriendly ? 'Yes' : 'No' }}</div>
          <div class="proposed" [class.changed]="isFieldChanged('vehicle.babyFriendly')">{{ changedDriver.vehicle?.babyFriendly ? 'Yes' : 'No' }}</div>
        </div>
      </div>

      <section class="admin-area">
        <h4>Admin notes</h4>
        <textarea rows="4" class="form-control" [(ngModel)]="adminNotes" placeholder="Optional note for the user / audit log"></textarea>
        <div class="result mt-2" *ngIf="resultMessage">{{ resultMessage }}</div>
      </section>
    </main>
  </section>
</div>
