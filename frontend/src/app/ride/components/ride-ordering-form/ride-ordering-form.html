<div class="ride-ordering-section row m-0">
    <div class="col-12 bg-black text-white rounded-4 custom-form-container">
        <div class="ride-ordering-container p-4">
            <form class="ride-ordering-form">
                <ng-container *ngIf="!showPreferences">
                <h2 class="form-title mb-4">Order your ride</h2>

                                <div class="custom-dropdown w-100 mb-2">
                                    <div class="custom-dropdown-toggle input-focus d-flex justify-content-between align-items-center" (click)="toggleFavoriteDropdown()">
                                        <span class="selected-text">{{ selectedFavorite || '-- Choose favorite --' }}</span>
                                        <span class="chev">â–¾</span>
                                    </div>
                                    <ul *ngIf="favoriteOpen" class="custom-dropdown-menu">
                                        <li class="custom-dropdown-item" (click)="selectFavorite('')">-- Choose favorite --</li>
                                        <li *ngFor="let f of favorites" class="custom-dropdown-item" (click)="selectFavorite(f.name)">{{ f.name }}</li>
                                    </ul>
                                </div>

                <app-input-component class="form-input w-100" borderColor="white" variant="secondary" type="text" height="35px" placeholder="Enter pickup address" [value]="pickupAddress" (valueChange)="onPickupChange($event)" [suggestions]="pickupSuggestions" (suggestionSelect)="onPickupSuggestion($event)"></app-input-component>
                <div class="error" *ngIf="validator.addressError(pickupAddress)"> {{ validator.addressError(pickupAddress) }}</div>

                <div class="mt-2">
                    <app-input-component class="form-input w-100" borderColor="white" variant="secondary" type="text" height="35px" placeholder="Enter destination address" [value]="destinationAddress" (valueChange)="onDestinationChange($event)" [suggestions]="destinationSuggestions" (suggestionSelect)="onDestinationSuggestion($event)"></app-input-component>
                </div>
                <div class="error" *ngIf="validator.addressError(destinationAddress)"> {{ validator.addressError(destinationAddress) }}</div>

                <div class="stops-section mt-3">
                    
                    <div *ngFor="let stop of stops; let i = index; trackBy: trackByIndex"
                         class="stop-row mb-2 d-flex flex-column"
                         draggable="true"
                         (dragstart)="onDragStart($event, i)"
                         (dragover)="onDragOver($event, i)"
                         (dragleave)="onDragLeave($event, i)"
                         (drop)="onDrop($event, i)"
                        (dragend)="onDragEnd($event)"
                         [class.drag-over]="dragOverIndex === i"
                         [class.dragging]="draggedIndex === i">
                        <div class="d-flex w-100 align-items-start">
                            <div class="flex-grow-1">
                                <app-input-component class="form-input" borderColor="white" variant="secondary" type="text" height="35px" placeholder="Enter stop address" [value]="stops[i]" (valueChange)="onStopChange($event, i)" [suggestions]="stopSuggestions[i] || null" (suggestionSelect)="onStopSuggestion($event, i)"></app-input-component>
                                <div class="error" *ngIf="validator.addressError(stops[i])">{{ validator.addressError(stops[i]) }}</div>
                            </div>
                            <button type="button" class="trash-btn ms-2" (click)="removeStop(i)">ðŸ—‘</button>
                        </div>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <button type="button" class="add-stop-icon me-3" (click)="addStop()" aria-label="Add stop"><span class="plus">+</span></button>
                        <label class="form-label mb-0">Add stop address</label>
                    </div>
                </div>

                <div *ngIf="lastEstimate" class="estimate-box mt-2 p-2" style="border-radius:6px;">
                    <div><strong>Distance:</strong> {{ lastEstimate.distanceKm ?? lastEstimate.distanceKmKm ?? lastEstimate.distanceKmValue ?? lastEstimate.distanceKm }} km</div>
                    <div><strong>Estimated time:</strong> {{ lastEstimate.estimatedTimeMinutes ?? lastEstimate.estimatedDurationMin ?? lastEstimate.estimatedTime }} minutes</div>
                </div>

                <div class="route-buttons d-flex gap-2 mt-3 mb-3">
                    <app-button class="show-route-btn" width="120%" height="35px" variant="primary" fontWeight="700" textTransform="uppercase" text="Show route" (click)="showRoute()"></app-button>
                </div>

                <app-button width="100%" height="35px" variant="secondary" fontWeight="700" textTransform="uppercase" text="Choose route" [disabled]="hasErrors()" (click)="chooseRoute()"></app-button>

                </ng-container>
                <ng-container *ngIf="showPreferences">
                    <app-ride-preference-form (confirm)="onPreferencesConfirm($event)" (cancel)="showPreferences=false"></app-ride-preference-form>
                </ng-container>
            </form>
        </div>
    </div>
</div>
